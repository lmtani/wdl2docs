{% extends "base.html" %}
{% from "macros/badges.html" import workflow_badge, task_badge, mixed_badge, external_badge, count_items %}
{% from "components/stats.html" import stats_grid, stat_card, stat_card_highlighted, search_box %}
{% from "components/tabs.html" import tabs_container, tab_button, tab_content, tab_notice %}
{% block title %}WDL Documentation - Index{% endblock %}
{% block header %}WDL Documentation{% endblock %}
{% block content %}
    <div class="card">
        <h2>Overview</h2>
        {% call stats_grid() %}
            {{ stat_card(total_files, 'Internal WDL Files') }}
            {{ stat_card(total_workflows, 'Workflows') }}
            {{ stat_card(total_tasks, 'Tasks') }}
            {% if total_external > 0 %}
                {{ stat_card_highlighted(total_repositories_external if total_repositories_external is defined else total_external, 'External Files') }}
            {% endif %}
        {% endcall %}
    </div>
    <div class="card">
        <h2>üîç Search</h2>
        {{ search_box('searchBox', "Search workflows, tasks, or files... (e.g., 'alignment', 'variant calling')") }}
    </div>
    <!-- Hidden search data -->
    <script id="searchDataInternal" type="application/json">
[
    {% set internal_docs = documents | selectattr('is_external', 'equalto', False) | list %}
    {% for doc in internal_docs %}
    {
        "name": "{{ doc.name | e }}",
        "type": "{{ doc.document_type | upper }}",
        "path": "{{ doc.relative_path | normalize_path | e }}",
        "url": "{{ doc.relative_path | normalize_path | e | replace('.wdl', '.html') }}",
        "description": "{{ doc.description | e if doc.description else '' }}",
        "isExternal": false
    }{% if not loop.last %},{% endif %}
    {% endfor %}
]
    </script>
    <script id="searchDataExternal" type="application/json">
[
    {% set external_docs = documents | selectattr('is_external', 'equalto', True) | list %}
    {% for doc in external_docs %}
    {
        "name": "{{ doc.name | e }}",
        "type": "{{ doc.document_type | upper }}",
        "path": "{{ doc.relative_path | normalize_path | e }}",
        "url": "{{ doc.relative_path | normalize_path | e | replace('.wdl', '.html') }}",
        "description": "{{ doc.description | e if doc.description else '' }}",
        "isExternal": true
    }{% if not loop.last %},{% endif %}
    {% endfor %}
]
    </script>
    <!-- Tabs Navigation -->
    {% call tabs_container() %}
        {{ tab_button('internal', 'üìÅ', 'Internal', total_files, active=true) }}
        {% if total_external > 0 %}{{ tab_button('external', 'üì¶', 'External', total_external) }}{% endif %}
        {% if total_errors > 0 %}{{ tab_button('errors', '‚ö†Ô∏è', 'Errors & Warnings', total_errors) }}{% endif %}
    {% endcall %}
    <!-- Internal Tab Content -->
    {% call tab_content('internal', active=true) %}
        {% if workflows %}
            <div class="card section">
                <h2>Workflows</h2>
                <p class="description">Main workflow files that orchestrate tasks and subworkflows.</p>
                <ul class="file-list">
                    {% for doc in workflows %}
                        <li>
                            {{ workflow_badge() }}
                            <a href="{{ doc.relative_path | normalize_path | replace('.wdl', '.html') }}">
                                <strong>{{ doc.workflow.name }}</strong>
                            </a>
                            - <code>{{ doc.relative_path | normalize_path }}</code>
                            {% if workflow_caller_counts.get(doc.workflow.name, 0) > 0 %}
                                <span style="color: #a371f7; font-weight: 500;">(used by {{ workflow_caller_counts[doc.workflow.name] }} workflow{{ 's' if workflow_caller_counts[doc.workflow.name] != 1 else '' }})</span>
                            {% endif %}
                            {% if doc.workflow.description %}
                                <br>
                                <span class="description">{{ doc.workflow.description }}</span>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        {% if mixed_files %}
            <div class="card section">
                <h2>Mixed Files (Workflow + Tasks)</h2>
                <p class="description">Files containing both workflow definition and task implementations.</p>
                <ul class="file-list">
                    {% for doc in mixed_files %}
                        <li>
                            {{ mixed_badge() }}
                            <a href="{{ doc.relative_path | normalize_path | replace('.wdl', '.html') }}">
                                <strong>{{ doc.workflow.name }}</strong>
                            </a>
                            - <code>{{ doc.relative_path | normalize_path }}</code>
                            ({{ doc.tasks|length }} task{{ 's' if doc.tasks|length != 1 else '' }})
                            {% if workflow_caller_counts.get(doc.workflow.name, 0) > 0 %}
                                <span style="color: #a371f7; font-weight: 500;">(used by {{ workflow_caller_counts[doc.workflow.name] }} workflow{{ 's' if workflow_caller_counts[doc.workflow.name] != 1 else '' }})</span>
                            {% endif %}
                            {% if doc.workflow.description %}
                                <br>
                                <span class="description">{{ doc.workflow.description }}</span>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        {% if task_files %}
            <div class="card section">
                <h2>Task Libraries</h2>
                <p class="description">Files containing reusable tasks.</p>
                <ul class="file-list">
                    {% for doc in task_files %}
                        <li>
                            {{ task_badge() }}
                            <a href="{{ doc.relative_path | normalize_path | replace('.wdl', '.html') }}">
                                <strong>{{ doc.name }}</strong>
                            </a>
                            - <code>{{ doc.relative_path | normalize_path }}</code>
                            ({{ doc.tasks|length }} task{{ 's' if doc.tasks|length != 1 else '' }})
                            {% if doc.description %}
                                <br>
                                <span class="description">{{ doc.description }}</span>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    {% endcall %}
    <!-- External Tab Content -->
    {% if total_external > 0 %}
        {% call tab_content('external') %}
            {{ tab_notice('‚ö†Ô∏è', 'Third-Party Resources', 'These are external workflows and tasks from third-party sources. They are used as-is and not modified by this project.') }}
            {% if external_workflows %}
                <div class="card section">
                    <h2>External Workflows</h2>
                    <p class="description">Workflow files from external dependencies.</p>
                    <ul class="file-list">
                        {% for doc in external_workflows %}
                            <li>
                                {{ workflow_badge() }}
                                {{ external_badge() }}
                                <a href="{{ doc.relative_path | normalize_path | replace('.wdl', '.html') }}">
                                    <strong>{{ doc.workflow.name }}</strong>
                                </a>
                                - <code>{{ doc.relative_path | normalize_path }}</code>
                                {% if workflow_caller_counts.get(doc.workflow.name, 0) > 0 %}
                                    <span style="color: #a371f7; font-weight: 500;">(used by {{ workflow_caller_counts[doc.workflow.name] }} workflow{{ 's' if workflow_caller_counts[doc.workflow.name] != 1 else '' }})</span>
                                {% endif %}
                                {% if doc.workflow.description %}
                                    <br>
                                    <span class="description">{{ doc.workflow.description }}</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            {% if external_mixed %}
                <div class="card section">
                    <h2>External Mixed Files</h2>
                    <p class="description">External files containing both workflows and tasks.</p>
                    <ul class="file-list">
                        {% for doc in external_mixed %}
                            <li>
                                {{ mixed_badge() }}
                                {{ external_badge() }}
                                <a href="{{ doc.relative_path | normalize_path | replace('.wdl', '.html') }}">
                                    <strong>{{ doc.workflow.name }}</strong>
                                </a>
                                - <code>{{ doc.relative_path | normalize_path }}</code>
                                ({{ doc.tasks|length }} task{{ 's' if doc.tasks|length != 1 else '' }})
                                {% if workflow_caller_counts.get(doc.workflow.name, 0) > 0 %}
                                    <span style="color: #a371f7; font-weight: 500;">(used by {{ workflow_caller_counts[doc.workflow.name] }} workflow{{ 's' if workflow_caller_counts[doc.workflow.name] != 1 else '' }})</span>
                                {% endif %}
                                {% if doc.workflow.description %}
                                    <br>
                                    <span class="description">{{ doc.workflow.description }}</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            {% if external_tasks %}
                <div class="card section">
                    <h2>External Task Libraries</h2>
                    <p class="description">Task-only files from external dependencies.</p>
                    <ul class="file-list">
                        {% for doc in external_tasks %}
                            <li>
                                {{ task_badge() }}
                                {{ external_badge() }}
                                <a href="{{ doc.relative_path | normalize_path | replace('.wdl', '.html') }}">
                                    <strong>{{ doc.name }}</strong>
                                </a>
                                - <code>{{ doc.relative_path | normalize_path }}</code>
                                ({{ doc.tasks|length }} task{{ 's' if doc.tasks|length != 1 else '' }})
                                {% if doc.description %}
                                    <br>
                                    <span class="description">{{ doc.description }}</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        {% endcall %}
    {% endif %}
    <!-- Errors & Warnings Tab Content -->
    {% if total_errors > 0 %}
        {% call tab_content('errors') %}
            <div class="card section">
                <div class="error-notice">
                    <span class="notice-icon">‚ö†Ô∏è</span>
                    <div class="notice-content">
                        <strong>Parsing Issues</strong>
                        <p>
                            The following errors and warnings were encountered while generating documentation. These files may have syntax errors or incompatibilities.
                        </p>
                    </div>
                </div>
            </div>
            {% if syntax_errors %}
                <div class="card section">
                    <h2>üî¥ Syntax Errors ({{ syntax_errors|length }})</h2>
                    <p class="description">WDL files that failed to parse due to syntax errors.</p>
                    <div class="error-list">
                        {% for error in syntax_errors %}
                            <div class="error-item syntax-error">
                                <div class="error-header">
                                    <span class="badge badge-error">SYNTAX ERROR</span>
                                    <code class="error-file">{{ error.relative_path | normalize_path }}</code>
                                </div>
                                {% if error.location_info %}
                                    <div class="error-location">
                                        <span class="location-icon">üìç</span>
                                        {{ error.location_info }}
                                    </div>
                                {% endif %}
                                <div class="error-message">
                                    <pre>{{ error.error_message }}</pre>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            {% if other_errors %}
                <div class="card section">
                    <h2>üî¥ Other Errors ({{ other_errors|length }})</h2>
                    <p class="description">Files that encountered errors during processing.</p>
                    <div class="error-list">
                        {% for error in other_errors %}
                            <div class="error-item other-error">
                                <div class="error-header">
                                    <span class="badge badge-error">{{ error.error_type }}</span>
                                    <code class="error-file">{{ error.relative_path | normalize_path }}</code>
                                </div>
                                <div class="error-message">
                                    <pre>{{ error.error_message }}</pre>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            {% if warnings %}
                <div class="card section">
                    <h2>‚ö†Ô∏è Warnings ({{ warnings|length }})</h2>
                    <p class="description">Non-critical issues that may affect documentation quality.</p>
                    <div class="error-list">
                        {% for warning in warnings %}
                            <div class="error-item warning-item">
                                <div class="error-header">
                                    <span class="badge badge-warning">WARNING</span>
                                    <code class="error-file">{{ warning.relative_path | normalize_path }}</code>
                                </div>
                                <div class="error-message">{{ warning.error_message }}</div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endcall %}
    {% endif %}
{% endblock %}
