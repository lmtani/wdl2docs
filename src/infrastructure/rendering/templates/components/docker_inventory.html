{# Componente de invent√°rio Docker reutiliz√°vel #}
{% from "macros/badges.html" import external_badge, count_items %}
{# 
Renderiza uma lista de reposit√≥rios Docker com suas imagens e tasks associadas.

Par√¢metros:
- repositories: dicion√°rio de reposit√≥rios {repo_name: {image_count, images}}
- repo_index_offset: offset para IDs √∫nicos (padr√£o: 0, usar 1000+ para external)
- is_external: boolean para mostrar badge de external (padr√£o: false)
#}
{% macro docker_inventory_list(repositories, repo_index_offset=0, is_external=false) %}
    <div class="docker-inventory">
        {% for repo_name, repo_data in repositories.items() %}
            {% set repo_index = loop.index0 + repo_index_offset %}
            <div class="card docker-repository" data-repo="{{ repo_name }}">
                <div class="repository-header">
                    <h2>
                        <span class="repo-icon">üì¶</span>
                        {{ repo_name }}
                        {{ count_items(repo_data.image_count, 'image') }}
                        {% if is_external %}{{ external_badge() }}{% endif %}
                    </h2>
                </div>
                <div class="docker-images-list">
                    {% for image_data in repo_data.images %}
                        {% set image_index = loop.index0 %}
                        {% set unique_id = "img_" ~ repo_index ~ "_" ~ image_index %}
                        <div class="docker-image-item" data-image="{{ image_data.full_name }}">
                            <div class="image-header" onclick="toggleImageDetails('{{ unique_id }}')">
                                <div class="image-info">
                                    <span class="image-icon">üê≥</span>
                                    <div class="image-details">
                                        <strong class="image-name">{{ image_data.name }}</strong>
                                        {% if image_data.tag %}<span class="image-tag">:{{ image_data.tag }}</span>{% endif %}
                                        {% if image_data.is_parameterized %}
                                            <span class="badge badge-warning">Parameterized</span>
                                            {% if is_external and image_data.default_value %}
                                                <span class="badge badge-info"
                                                      title="Default value used when parameter is not provided">Default: {{ image_data.default_value }}</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="image-stats">
                                    <span class="task-count">{{ image_data.task_count }} task{{ 's' if image_data.task_count != 1 else '' }}</span>
                                    <span class="expand-icon" id="icon_{{ unique_id }}">‚ñ∂</span>
                                </div>
                            </div>
                            <div class="image-tasks-container"
                                 id="tasks_{{ unique_id }}"
                                 style="display: none">
                                <div class="tasks-header">
                                    <h4>Tasks using this image:</h4>
                                </div>
                                <ul class="tasks-list">
                                    {% for task_info in image_data.tasks %}
                                        <li class="task-item">
                                            <a href="{{ task_info.workflow_url }}" class="task-link">
                                                <span class="task-name">{{ task_info.task_name }}</span>
                                                <span class="workflow-name">in {{ task_info.workflow_name }}</span>
                                            </a>
                                            <span class="file-path">{{ task_info.file_path }}</span>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
{%- endmacro %}
